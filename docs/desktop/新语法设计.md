# SQL 模板新语法设计

## 目标
- 在当前 `{{name}}` 变量替换体系上引入条件与循环语法，支持基于用户输入动态裁剪 SQL 片段。
- 保持参数化执行的安全性，被裁剪掉的片段不会产生多余的 `$n` 占位符。
- 提升 Saved SQL 模板在筛选条件、动态列表（如 `IN (...)`）等场景下的表达能力。

## 设计原则
- **兼容性**：沿用 Handlebars 风格标记，现有 `{{var}}` 写法无须改动。
- **安全性**：所有变量仍走类型校验与参数化；`raw` 类型须由调用方明确启用。
- **可读性**：模板大片段建议保持完整 SQL 语义（含空格/换行），由编译阶段负责裁剪多余空白。
- **可测试性**：解析器产出 AST，可在单测中直接断言求值结果与生成的 SQL/values。

## 新增语法

> **实现状态提示**：截至 2025-09-17，运行时代码仅支持 `{{#when}}` 与 `{{#if}}`。本文档中提到的循环语法 `{{#each}}` 及其派生变量（如 `{{@index}}`、`{{@last}}` 等）仍在规划阶段，尚未在应用中落地。
### 条件块 `{{#when ...}}`
- 形式：`{{#when var1[, var2 ...]}} ... {{/when}}`
- 语义：所有列出的变量“有值”时渲染块内容。"有值" 定义为非 `undefined|null|''`。
- 场景：可选筛选条件、JOIN 开关等。

### 通用条件 `{{#if ...}}`
- 形式：`{{#if expr}} ... {{else}} ... {{/if}}`
- 表达式支持：
  - 逻辑：`&&`、`||`、`!`
  - 比较：`==`、`!=`、`>`、`>=`、`<`、`<=`
  - 常量：字符串、数字、`true/false/null`
  - `in`：`value in ['a','b']`
  - 辅助函数：`presence(var)`（判定变量是否有值）
- 说明：缺省 `else` 时仅在条件成立时渲染内容。

### 循环 `{{#each ...}}`（计划中，尚未实现）
- 形式：`{{#each listVar as item}} ... {{/each}}`
- 场景：批量 `IN` 列表或重复 `OR` 条件。
- 计划中的块上下文：`{{item}}`、`{{@index}}`，以及 `{{@first}}`、`{{@last}}` 等语法糖（目前模板解析器尚不识别这些标记）。

### 语义标签 `{{#sql ...}}`（可选）
- 目的：为 WHERE/AND 等片段提供语义提示，便于后期做多余关键字清理或格式化。
- 首版实现可先跳过解析处理，仅保留文本。

## 变量与求值规则
- 所有变量定义沿用 `SavedQueryVariableDef`，新增：
  - `itemType`：数组变量的元素类型（`text|number|uuid|raw|...`）。
- `required=false` 且无输入时：`{{var}}` 渲染为 `NULL`，`{{#when var}}` 判定为 false。
- 默认值在求值阶段生效，供条件表达式使用。
- 若变量在请求体中显式出现但值为 `null`/空串，则视为“用户清除”，不会回落至默认值（便于 enum 类型清空筛选）。
- `raw` 类型在块被移除时不会被渲染进最终 SQL。

## 编译流程
1. **解析**：模板 → AST，包含文本节点、变量节点、`when/if/each` 块。遇到语法错误返回带行列号的异常。
2. **裁剪**：在变量环境（含默认值）下遍历 AST：
   - `when`/`if` 选择合适分支；被裁剪的分支不再参与后续遍历。
   - `each` 将数组展开为若干子节点；支持空数组 fallback（未来可通过 `{{else}}`）。
3. **占位符编译**：对裁剪后的线性节点执行现有 `compileSql` 流程，维护 `$n` 顺序与 `placeholders`。
4. **预览渲染**：沿用 `renderSqlPreview`，扩展对数组值的渲染（如 `('a','b')`）。

## 空白处理
- 裁剪块后进行简单的空白规整：
  - 连续空行压缩为单行。
  - 自动移除 `WHERE`/`AND` 前后的孤立空白，可留到第二阶段实现。

## 示例
```sql
select *
from orders
where deleted_at is null
{{#when status}}
  and status = {{status}}
{{/when}}
{{#if presence(customer_ids) && customer_mode == 'whitelist'}}
  and customer_id in (
    {{#each customer_ids as cid}}
      {{cid}}{{#if !@last}},{{/if}}
    {{/each}}
  )
{{/if}}
```

> **说明**：示例中演示的 `{{#each}}`、`{{@last}}` 等语法属于未来版本目标，当前实现会对这些指令报错，落地后再行更新示例。

## 实现提醒
- 先编写解析与求值的 Vitest 单测，覆盖条件组合、数组为空、默认值等情况。
- 表达式解析采用受限 AST，禁止 `Function()` 动态执行。
- 更新 `packages/types` 中与变量相关的类型，确保前后端共享约束。
- `/docs/saved-sql.md` 后续需同步说明新语法。
