# Desktop Queries Page User Guide

_Last updated: 2025-09-24_

## 1. Layout Overview
- **Saved Queries Sidebar**: tree of folders and saved entries with search, expand/collapse state persisted through `usePersistentSet` (`localStorage['rdv.savedSql.expanded']`).
- **Query Editor**: shows metadata (name, description), SQL editor, variables table, and dynamic columns configuration driven by `useSavedSqlSelection`.
- **Run Panels**: `RunQueryPanel` for saved items and `TempQueryPanel` for ad-hoc SQL share a common `QueryRunnerLayout` with pagination controls, preview, execution actions, and result grid.
- **Script Drawers**: API script editor and task history drawers powered by `useQueryApiScriptTask`; accessible from the run panel actions dropdown.

## 2. Managing Saved Queries
1. **Create**: click `New Query`, fill name/description, write SQL. Variables are auto-detected (`{{var}}`) and listed under the Variables table.
2. **Save**: press `Save` (Ctrl/Cmd+S). Overwrites prompt when reusing a name; confirm to archive the previous revision.
3. **Open**: select an item from the sidebar; the form loads via `useSavedSqlSelection.loadSaved` and resets pagination.
4. **Duplicate / Rename**: use context menu actions in the sidebar. Duplication appends `copy` suffix and immediately opens the copy.
5. **Delete**: select item → choose `Delete` → confirm in `confirmDanger`. Removal refreshes the sidebar and switches to Temp mode.
6. **Import/Export**:
   - Export from toolbar → downloads JSON via `exportAllSavedSql` with timestamped file name.
   - Import accepts JSON generated by the export. Conflict resolution (overwrite/skip) provided via modal prompts.
7. **Column Widths**: the result grid remembers widths per query (`useSavedSqlColumnWidths`) and persists to the app DB when saving.

## 3. Running Saved Queries
- **Preview vs Execute**:
  - `Preview` compiles the AST and shows generated SQL without hitting the database.
  - `Run` executes select-only SQL; write statements trigger a confirmation dialog based on `QueryError.isWrite`.
- **Explain Plan**: choose format (`text` or `json`) and toggle `ANALYZE`. Results appear in the preview pane; executing explain leaves result rows untouched.
- **Pagination**: toggle enable/disable counts, pick page size (stored via `usePaginationState`). Buttons use zero-based indexes under the hood but display human-friendly numbering.
- **Totals Refresh**: `Count only` fetch recomputes `totalRows` without clearing `rows`; triggered either automatically on successful run or manually via the pagination bar.
- **Runtime Calculations**:
  - Cards appear when the saved query defines `CalcItemDef` entries. Auto-run and always-run modes execute right after a successful query.
  - Manual cards show status badges and allow re-running a computation (SQL aggregate or JS snippet) through `useRuntimeCalc`.

## 4. Temporary Queries
- Switch to `Temp` mode using the top-right toggle (`useSavedSqlSelection.switchToTemp`).
- Temp queries maintain an independent SQL buffer (`defaultTempSql` fallback) and share execution/pagination mechanics with saved queries.
- Saving a temp query promotes it into the saved list; all pagination and runtime calc state reset as part of `startNewSelection`.

## 5. Variables & Run Values
- Variables auto-detected on load populate the variables table. Default values originate from the saved query definition, with fallbacks to empty strings.
- At run-time, values live in `runValues`; the run panel records the latest inputs to re-use across executions.
- Missing values trigger `vars_missing` errors; the drawer surfaces inline hints and top-level notifications.
- Use the `Reset Values` button to restore defaults.

## 6. Script Tasks
- **Configuration**: open the script drawer (`Manage Scripts`). Fields include endpoint URL, method, batch sizes, throttling, and headers. Validation is enforced via Zod schemas.
- **Running**: from the query run panel choose `Run API Script`. Execution requires the latest query run to succeed. Confirmation summarizes key parameters.
- **Progress**: the task drawer shows batch counters, successes/failures, and stream events from the Tauri backend.
- **Cancel & Cleanup**: `Cancel Run`, `Download ZIP`, `Open Log`, `Clear History`, and `Delete Run` map to `useQueryApiScriptTask` helpers with notifications on completion.
- **Exports**: successful runs produce `manifest.json`, CSV batches, and zipped archives saved through standard OS dialogs.

## 7. Notifications & Safeguards
- Successes and failures route through `notifySuccess`/`notifyError` with consistent titles.
- Destructive actions (delete query, clear script history, allow write) rely on `confirmDanger` to require explicit confirmation.
- Write attempts (`INSERT/UPDATE/DELETE`) stay blocked unless the user acknowledges the prompt.
- Connectivity or permission errors surface both in toast notifications and inline banners within the run panel.

## 8. Troubleshooting Checklist
- **Missing Connection**: ensure a user connection is selected via the global header; pagination and run actions remain disabled otherwise.
- **Local Storage Disabled**: pagination size and folder expansion fall back to defaults but the console logs warning messages.
- **Script Tasks Stuck in Running**: check Tauri logs under `app_cache/api-script-runs/<runId>/run.log` and use `Cancel Run`.
- **Runtime Calc Failures**: inspect calc cards for error state; re-run after fixing SQL or JS. Errors do not clear query results but display toast + inline message.

## 9. Keyboard Shortcuts
- `Ctrl/Cmd + S`: Save query.
- `Ctrl/Cmd + Enter`: Execute run.
- `Shift + Ctrl/Cmd + Enter`: Preview SQL.
- `Ctrl/Cmd + P`: Toggle pagination enablement.

## 10. Recommended Workflow
1. Select or create a saved query.
2. Adjust variables and pagination settings.
3. Preview SQL → confirm.
4. Execute query → review results and runtime calc cards.
5. (Optional) Run API script based on the latest result set.
6. Export or archive results as needed, then document outcomes in project tracker.
