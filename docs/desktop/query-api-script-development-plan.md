# 查询页 API 脚本执行功能开发计划

## 概述
参照《查询页 API 脚本执行功能开发方案》，本计划将该功能落地拆分为可执行的阶段与任务，约束目标为：在桌面端查询页中提供脚本化 API 执行能力，确保任务可控、可追踪并生成 CSV 结果归档。

## 目标与主要交付物
- 完成 `app_prefs` 中脚本配置与任务记录的数据结构与访问层。
- 实现查询页脚本管理 UI、任务执行面板与任务历史视图。
- 在 Tauri 命令侧实现批量拉取、HTTP 调用、节流、错误策略与结果归档（CSV + ZIP）。
- 输出用户指导文档（操作说明、安全提示）。
- 提交覆盖关键流程的自动化测试与手动验收清单。

## 假设与约束
- 请求体模板首版仅支持固定 JSON 结构，不引入 Mustache 等模板引擎。
- 同一时间仅允许单个脚本任务运行；需确保用户切换页面时任务持续执行，并提供最小化状态反馈。
- 结果文件格式固定为 CSV；超过阈值拆分多文件后打包 ZIP。
- 外部 API 调用暂不实现认证缓存或重试机制，失败策略仅区分继续或中断。
- 保持只读数据库访问原则，不引入写库操作。

## 里程碑与排期（建议）
- **里程碑 1（~第 1 周）**：需求细化完成，定义最终字段、上限及任务状态机；评审通过。
- **里程碑 2（~第 2 周）**：数据层与脚本管理 UI 完成，包含单元测试与基础联调。
- **里程碑 3（~第 3 周）**：Tauri 批处理命令、HTTP 调用与文件归档实现并通过集成测试。
- **里程碑 4（~第 4 周）**：前后端整合、任务历史、下载流程、错误策略与取消处理完成；准备验收与文档。

## 当前进度（截至 2025-09-22）
- ✅ 需求侧字段/范围已确认：`fetchSize`、`sendBatchSize` 取值 `1~1000`，`sleepMs` 取值 `0~600000`，`requestTimeoutMs` 取值 `1000~600000`，HTTP 方法限定 `GET/POST/PUT/PATCH/DELETE`，错误策略限定 `continue/abort`。
- ✅ 数据层迁移已落地：`apps/desktop/src-tauri/src/migrations.rs` 增加版本 4，创建 `query_api_scripts` / `query_api_script_runs` 表并加索引、约束。
- ✅ TypeScript service 与单元测试完成：`apps/desktop/src/services/queryApiScripts.ts` + `queryApiScripts.test.ts` 已提供 CRUD、校验与运行记录读写。
- ✅ 查询页前端接入脚本管理：列表抽屉、编辑抽屉、执行入口以及 zod 校验默认值修正已合并，并提供 mock API 测试脚本（`tools/mock-api-script/server.py`）。
- ✅ Tauri 侧 `execute_api_script` 命令完成端到端实现：支持 PostgreSQL 只读会话、流式分页拉取、批量 HTTP 请求、错误策略（continue/abort）、节流、进度事件、CSV/manifest/ZIP 归档与临时目录管理。
- ✅ 查询页脚本执行按钮已与命令侧串联，并提供进度卡片 + 历史列表；订阅 `rdv://api-script/run-updated` 事件后能即时拉取首条运行记录并在失败时高亮错误。
- ✅ 引入 `tauri-plugin-dialog` + `@tauri-apps/plugin-dialog`，桌面端导出 ZIP 时调用系统保存对话框。
- ✅ 新增取消、结果导出、日志查看与缓存清理命令：`cancel_api_script_run`、`export_api_script_run_zip`、`read_api_script_run_log`、`cleanup_api_script_cache` 已实现，并在调用前完成路径校验与错误处理。
- ⛔ 全局通知/最小化状态栏与桌面端用户文档尚未排期，待前端整合后补充。

## 任务拆解
### 需求与设计对齐
- ✅ 补充字段限制（`fetchSize/sendBatchSize/sleepMs/requestTimeoutMs` 合理区间）。
- 定义任务状态机（待执行/运行中/暂停/成功/失败/取消）与进度事件结构。
- 评估用户切换页面后的通知交互（系统通知或全局提示）。

### 数据层（app_prefs）
- ✅ 设计 `query_api_scripts` 与 `query_api_script_runs` 表结构迁移脚本（限 SQLite）。
- ✅ 编写 DAO 与类型定义，确保与前端 TypeScript 接口一致。
- ✅ 单元测试覆盖 CRUD、JSON 字段读写与并发访问场景。

### 前端脚本管理 UI
- ✅ 在查询页新增脚本列表、详情抽屉与表单验证（用 `zod`）。
- ✅ 实现脚本新建、复制、删除、导入/导出，保持与查询 ID 的关联。
- ✅ 处理敏感 Header 遮罩显示与编辑交互。

### 任务执行面板
- ✅ 在结果区域集成脚本选择器与执行按钮。
- ✅ 展示实时进度、成功/失败计数、最新错误摘要，并在事件延迟时以占位记录兜底；补充取消按钮，直接调用 `cancel_api_script_run`。
- ⛔ 在用户离开当前页面时提供最小化进度提示（如顶部状态条或全局通知）。

- ✅ 提供 `execute_api_script` 全量实现：串行任务锁、脚本快照、分页取数、HTTP 请求、错误策略、节流、CSV/manifest/ZIP、缓存目录与日志全部落地。
- ✅ 推送进度/日志事件格式已定稿并输出 `rdv://api-script/run-updated`，前端已订阅并合并事件，确保实时刷新。

### 任务历史与日志
- ✅ SQLite 运行记录现已写入进度统计、文件路径与错误提示；前端历史列表与状态卡同步展示最新记录与错误信息。
- ✅ 历史面板支持重新导出 ZIP（系统保存对话框）、查看批次日志详情，并提供缓存清理入口（调用 `cleanup_api_script_cache`）。

### 文档与支持
- 更新桌面端用户指南，说明脚本配置、执行流程、安全提示与限制，并列出 CSV/manifest/log 文件结构。
- 补充安全清单，强调只读访问、HTTPS 推荐与敏感 Header 管理。

## 测试计划
- 单元测试：脚本配置验证、DAO、任务状态转换、HTTP 请求参数构造、CSV/manifest 生成等。
- 集成测试：
  - 使用 Mock API 服务验证节流、超时与错误策略，覆盖 continue/abort 分支。
  - 覆盖 CSV 拆分、ZIP 打包、日志写入与文件保存流程。
  - 验证任务取消、页面切换与缓存清理场景。
- 手动测试：全量走查 UI 流程、边界配置值、HTTP 错误、磁盘空间不足等情况。

## 风险与应对
- **大数据集导致内存压力**：控制 `fetchSize/sendBatchSize` 上限，并在 Rust 侧流式处理。
- **外部 API 过慢**：默认较长超时并提示用户；提供进度日志以便诊断。
- **临时文件残留**：实现定时清理策略，启动时扫描并清理过期目录。
- **用户切换页面中断感知**：通过全局状态栏或通知提醒任务仍在执行。

## 验收准备
- 与产品确认所有待定项已落地。
- 准备验收数据集、Mock API 与手动测试脚本。
- 产出验收记录模板，与验收标准文档保持同步。
