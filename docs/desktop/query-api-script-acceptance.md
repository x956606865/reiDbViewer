# 查询页 API 脚本执行功能验收标准

## 验收范围
- 桌面端查询页的 API 脚本管理、执行、任务历史及结果下载能力。
- Tauri 后端批处理命令 `execute_api_script` 及其与前端的协同。
- 本地文件归档与日志输出。

## 前置条件
- 已完成数据库只读连接配置，并可在查询页执行 SQL。
- `app_prefs` 已完成新增表结构的迁移，能够持久化脚本与任务记录。
- 至少存在一个查询及其关联脚本配置，脚本包含所有必填字段并通过验证。
- 提供可用的外部 API（或 Mock 服务）用于联调，支持 2xx、4xx、5xx 等响应场景。

## 功能验收条目
1. **脚本管理**
   - 新建/编辑脚本时字段校验准确，`fetchSize`、`sendBatchSize` 需在 `1~1000`；`sleepMs` 需在 `0~600000`；`requestTimeoutMs` 需在 `1000~600000`。
   - HTTP 方法仅允许 `GET/POST/PUT/PATCH/DELETE`；错误策略仅允许 `continue`、`abort`。
   - 支持多脚本关联同一查询，列表展示名称、更新时间、错误策略等关键信息。
   - 请求头可添加、编辑、删除，重复键阻止保存；敏感值默认遮罩，悬停或点击可临时查看。
   - 支持脚本导入/导出，导出的 JSON 能够重新导入并校验通过。

2. **执行入口与校验**
   - 仅在最近一次 SQL 执行成功且存在结果时允许启动脚本，否则给出明确提示。
   - 执行前弹出确认信息，展示脚本关键配置与安全提示。

3. **批处理执行流程**
   - 数据按配置的 `fetchSize` 分批拉取，并附带稳定排序；服务端日志记录每个批次的范围。
   - 每批数据按 `sendBatchSize` 拆分请求体，发送顺序正确，不丢失重复数据。
   - 请求体符合预期 JSON 结构，包含本批数据全部字段。
   - 每次请求后遵循 `sleepMs` 节流；可通过日志或外部监控确认。
   - 超过 `requestTimeoutMs` 的请求被判定为超时并按错误策略处理。
   - 运行日志 (`run.log`) 以 JSON Lines 记录每个请求的批次序号、行区间、耗时、响应码与错误摘要。

4. **错误策略**
   - `continue`：错误请求写入错误 CSV，任务继续处理剩余数据，最终状态为“已完成（含错误）”。
   - `abort`：遇到错误立即停止，任务状态为“已中断”，未处理数据量在日志中记录。
   - 所有错误信息包含响应码、耗时、错误体摘要。

5. **进度与交互**
   - 执行过程中前端消费 `rdv://api-script/run-updated` 事件，显示总批次数、已完成批次、成功/失败条数。
   - 若事件先于运行记录落库返回，前端需根据事件立即生成占位记录并更新状态卡，失败时及时展示错误摘要，刷新后与真实记录合并。
   - 支持用户手动取消，取消后任务状态为“已取消”，产生的文件完整可供排查。
   - 用户切换页面或最小化应用时仍可在全局状态栏/通知中看到任务进行中提示。

6. **结果归档与下载**
   - 成功记录、失败记录分别写入 CSV，超过阈值（默认 50k 行）自动拆分文件 `Part-x.csv`。
   - 生成的 `manifest.json` 包含脚本快照（名称、配置，敏感 header 应遮罩）、执行时间、批次统计、文件列表。
   - ZIP 打包完成后弹出保存对话框，可选择路径；取消保存时 ZIP 保留在缓存目录并记录日志。
 - 任务历史可再次导出 ZIP，并能清晰展示文件存放路径。
  - 再次导出 ZIP 时调用系统保存对话框（依赖 `tauri-plugin-dialog`），取消操作不会删除原缓存。

7. **任务历史与日志**
   - 历史列表展示脚本名称、执行时间、持续时长、成功/失败条数、最终状态。
   - 可在详情弹窗查看最新日志，包含批次级别的请求摘要、响应状态、错误详情，并指向缓存目录的 `run.log`。
   - 支持清理过期任务记录与文件（默认清理 24 小时以上），清理后对应 ZIP 与日志不可再访问。

## 性能与可靠性
- 在默认批量配置下（示例：`fetchSize=500`, `sendBatchSize=100`）处理 5 万条数据应在可接受时间内完成，CPU/内存占用无异常峰值。
- 对外请求速率符合节流规则，无明显突刺；支持通过日志验证间隔控制。
- 应用异常退出或崩溃后重新启动，能识别并提示是否继续/清理未完成任务。

## 安全与合规
- 仅允许 HTTPS 地址；若用户选择 HTTP，需弹出二次确认并记录操作。
- 敏感 Header 在界面与日志中均进行遮罩；日志不落明文密钥。
- 只读数据库策略未被破坏，Tauri 命令仅执行 SELECT。
- 文件保存路径需通过系统对话框选择，不覆盖现有文件，默认放置在用户指定目录。

## 文件与缓存管理
- 缓存目录结构为 `app_cache/api-script-runs/<run_id>/`，包含 CSV、日志、manifest 与 ZIP。
- 超过 24 小时未保存的 ZIP 自动清理，并在任务历史中标注“文件已清理”。
- 清理动作需写入日志并在 UI 中反馈。

## 验收流程
1. 准备测试 SQL 与 Mock API，确保覆盖成功、超时、错误响应。
2. 按照“功能验收条目”逐项执行测试，并记录截图/日志。
3. 验证 ZIP 内容与 manifest 信息，核对记录条数与错误明细。
4. 检查日志输出、任务历史展示、缓存清理行为。
5. 产品与 QA 双方签字确认，存档验收记录。

## 不在范围
- 不实现脚本执行的自动定时任务。
- 不提供并发多任务执行能力。
- 不提供自定义模板语言或重试策略。
