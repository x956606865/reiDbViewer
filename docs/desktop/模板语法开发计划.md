# SQL 模板语法开发计划

## 范畴
- 引入 `when/if/each` 等控制结构，支持 Saved SQL 模板的动态裁剪。
- 更新类型定义、运行时编译器与预览逻辑，保持现有 API 行为兼容。
- 覆盖主要正反向路径的单元测试。

## 里程碑
1. **准备阶段**
   - 梳理现有 `sql-template.ts` 功能与依赖。
   - 在 `packages/types` 中扩展变量定义数据结构（数组元素类型等）。
2. **解析器实现**
   - 编写模板解析 AST（文本、变量、块）。
   - 定义表达式求值器，支持逻辑与比较运算及 `presence()`。
   - 单测覆盖基本语法、嵌套块、语法错误提示。
3. **编译与渲染集成**
   - 在 `sql-template.ts` 中引入解析 + 裁剪流程，产出最终 SQL。
   - 扩展 `renderSqlPreview` 处理数组与新块上下文。
   - 保持 `raw` 变量与参数化逻辑不变。
4. **文档与前端更新**
   - 更新 `docs/saved-sql.md` 与用户侧说明。
   -（可选）Saved SQL 编辑器提示新语法。

## 测试策略
- `packages/query-engine`：新增 `template` 测试套件，涵盖：
  - `when` 条件命中/跳过。
  - `if/else` 多分支。
  - `each` 数组展开与空数组处理。
  - 表达式运算与默认值判定。
  - 错误用例（未闭合块、未定义变量）。
- `apps/web/lib/sql-template.test.ts`（新建）：验证编译产物中的 SQL 文本与 `values`。

## 风险与缓解
- **表达式解析复杂度**：采用受限语法，禁止任意 JS；通过 AST + 解释器落地。
- **性能影响**：缓存解析结果（按模板字符串哈希）以减少重复解析。
- **向后兼容**：新增语法为超集；现有模板无需调整。

## 验收标准
- 单元测试覆盖率满足新增逻辑场景；CI 通过。
- 新模板语法能在 Saved SQL 页面通过接口返回正确 SQL/预览。
- 文档说明被更新，用户可参考示例编写模板。
